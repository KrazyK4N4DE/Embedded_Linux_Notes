# CAN通信基础

- 车载网络概述
- CAN
  - 概述
  - 物理层
  - 数据链路层
- CANFD
- J1939
  - 概述
  - 物理层
  - 数据链路层

## 车载网络概述

### 车联网

按应用场景可分为车内网、车际网、车云网。按传输速度可分为低速、中速、高速。

### 为什么要使用数据总线？

1. 减少线束。
2. 使用电子信息代替机械传动。如线控转向、线控刹车，使汽车由机械化 → 电气化。

### 主要车载网络协议情况

|名称|概要|最大速度|推动单位|
|:-------:|:-------:|:-------:|:-------:|
|CAN|车身/控制系统用LAN协议|1Mbit/s|Bosch、ISO 11898|
|LIN|车身控制用LAN协议|20kbit/s|LIN协议会|
|FlexRay|重视安全，按用途分类的LAN协议|10Mbit/s或20Mbit/s|BMW|
|MOST|信息通讯协议|22.5Mbit/s|MOST合作组织|
|IDB-C|以CAN为基础的LAN协议|250kbit/s|IDM论坛|

### 车用总线

车用总线是现场总线的一种，特点如下：

- 实时性强
- 可靠性高
- 安全性好
- 线路简单
- 范围小
- 节点数少
- 传输速度要求不高

其优点为：

1. 减少线束
2. 电子信息代替机械传递信息
3. 改善了车辆灵活性
4. 改善车辆性能
5. 数据共享
6. 车辆变成一个整体

拓扑结构：

- 星型
- 总线
- 环型

传输介质：

- **双绞线**
- 同轴电缆
- 光纤

通信方式：

- 单工
- 半双工。如对讲机
- 全双工。如现代电话

---

## CAN概述

特点：

- 双线差分信号
- 节点数可以动态改变
- 可多对多发送，各节点平等
- 优先级。依赖于报文ID
- 相关性过滤。依赖于报文ID
- 短帧结构
- 通信介质灵活。多用双绞线
- 节点成本低
- 开发技术简单
- 系统数据一致性好

CAN是一种协议，定义了数据该如何传输。

---

## CAN物理层

### CAN的节点结构

- **微控制器**：负责与其他节点的应用层数据交互、处理，当数据需要发送时，微控制器会将数据传递给CAN控制器。
- **CAN控制器**：
  - 收到微控制器传来的数据时，进行报文封装，之后以二进制码流的方式传递给收发器。
  - 收到CAN收发器传来的数据时，进行报文解封装，并将应用层数据打包给微控制器进行处理。
- **CAN收发器**：负责将二进制信号与物理电平信号转换。
  - 收到CAN控制器传过来的数据时，根据CAN协议物理层定义的电平转换逻辑，将CANH和CANL的电平拉到相应的阈值。
  - 收到总线到的数据时，将将CANH和CANL的**差分电平**解析成二进制流传给CAN控制器。

![20230712235837](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/20230712235837.png)

CAN标准若是ISO11898，则为高速CAN(125kbps ~ 1Mbps)。

![20230720154725](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/20230720154725.png)

CAN标准若是ISO11519，则为低速CAN(10kbps ~ 125kbps)。

![20230720154300](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/20230720154300.png)

### 总线拓扑结构

||最小值|名义值|最大值|
|:-------:|:-------:|:-------:|:-------:|
|总线(干线)长|0|/|40m|
|支线长|0|/|1m|
|节点距|0|/|40m|
|终端电阻|100Ω|120Ω|130Ω|

### 双绞线

分为屏蔽双绞线和非屏蔽双绞线。

||最小值|名义值|最大值|
|:-------:|:-------:|:-------:|:-------:|
|特征阻抗$Z_0$|95Ω|120Ω|140Ω|
|单位电阻|/|70mΩ/m|/|
|单位延迟|/|5ns/m|/|

***为什么要使用双绞线？***

- 相比于散线(单根)，特征阻抗稳定，因为**受干扰时电平同时变化，电压差不变**。
- 相比于平行线，也是更稳定。
- 相比于同轴电缆，成本低。

***特征阻抗受什么影响？***

1. 导线截面积
2. 屏蔽层
3. 绞率
4. 通电频率

### 终端反射现象

指信号传到接线终端时，反弹回来，使得线上电压叠加变高。

可能的产生原因：

1. 传入终端是电流变化过大，产生**磁场**，又由磁场感应生成**电场**，最后产生**反射信号**。
2. 导线有电感保持电流不变，传入终端时电流突然变为0。

**为了消除终端反射现象，需要在终端处加上终端电阻，值应匹配特征阻抗的大小。**

![20230720155303](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/20230720155303.png)

更进一步，为了避免地漂，需接地：

![20230720155359](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/20230720155359.png)

---

## CAN数据链路层

- 通信机制
  - 线与
  - 优先级
  - 相关性
- CAN帧类型
  - 数据帧
    - 标准帧
    - 扩展帧
  - 远程帧
  - 错误帧
    - 主动错误
    - 被动错误
  - 超载帧
  - 帧间空间
- **错误检测与处理**
- 位定时与同步
  - 硬同步
  - 重同步
- CAN控制器

---

### 通信机制

#### 发送报文

发送报文步骤：

1. 检测Bus状态
2. 若为空闲，则发送报文 (一位一位地发)，并**回读**

根据**线与机制**，若几个收发器同时发送报文，会进行ID**仲裁** (判断哪条报文应该先发)，**ID值越小，优先级越高**。原理是：ID值越小，0位越靠前，ID对比中第一次出现显性位覆盖隐性位时，ID值大的报文立即退出仲裁，进入只听状态，等待下次总线空闲时再发送。如0001和0100，在第二位对比中0001为显性位，0100为隐性位，则0001的显性位将覆盖0100，优先发送。

![4a72359cfe1250057f3978a736a034b](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/4a72359cfe1250057f3978a736a034b.jpg)

**例1**：

![20230724170509](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/20230724170509.png)

解析：

![8847a544bd755cf44e975fbe9d4c701](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/8847a544bd755cf44e975fbe9d4c701.jpg)

- ID值较小的报文优先级高
- 须注意报文长度，如第一个5发完，除了7和3，其它都没轮到

则总线报文顺序为：5363567。

**例2**：

![20230724171218](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/20230724171218.png)

解析：

![a103971473ffd264e85024b7ca24ea1](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/a103971473ffd264e85024b7ca24ea1.jpg)

- 这里A节点中出现了2和1，但是2的时间顺序比1要前，所以2先发送

则总线报文顺序为：1213。

总结：**同一节点看时间顺序，不同节点看ID大小**。

*Tip：数据帧要比远程帧优先级高。*

#### 接收报文

相关性由报文ID控制，与收发器相同的ID会接入节点，不相同的则会过滤掉。

采用NRZ编码，不使用曼彻斯特编码。

- NRZ编码：0是低电平，1是高电平。
  - 优点：报文紧凑
- 曼彻斯特编码：0是上升沿，1是下降沿。
  - 优点：能够非常准确地**位同步**，像NRZ编码那样若出现连续多个同位的数据时会出现误差

##### NRZ与位填充

NRZ编码由于上升下降沿少，会出现误差，因此需要一些定时的方法，比如位填充。位填充方法应用在**CAN总线**上：

- **发送**连续5个相同位后，补一个极性相反位。
- **接收**连续5个相同位后，去一个极性相反位。

如要发送6个1，则发送时要在第5个1后面补一个0；接收时就把这个补的0去掉。

![ccbd028674739bbd54baee568fa844f](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/ccbd028674739bbd54baee568fa844f.jpg)

---

### CAN数据帧

![f66949ae2be212ac1e559cabb70c73b](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/f66949ae2be212ac1e559cabb70c73b.jpg)

标准帧中：

- Idle：总线空闲。
- SOF：帧起始，由**1位显性位**组成。
- ID：帧ID，标准帧11位，扩展帧29位。定义报文的优先级，数字越小优先级越高。
- RTR：1位，显性表示数据帧，隐性表示远程帧。
- IDE：1位，显性表示标准帧，隐性表示扩展帧。
- r：保留位，1位显性。
- DLC：表示数据长度，决定了Data Field的字节数。共4位，0~7表示0~7bytes，8~15表示8bytes。
- Data Field：收发的数据消息。0~8字节，**首先发送最高有效位 (MSB)**。
- CRC：循环冗余校验，从SOF到Data Field的所有数据进行处理，一般使用**模二除法**生成CRC码。发送节点计算一遍CRC码，接收节点也计算一遍CRC码，两者进行比较，若无误，说明报文传输正确；反之说明报文出错。15位。
- CRC DEL：界定符，分隔两段的作用。1位隐性。
- ACK DEL：同上。
- ACK：应答，占1位。
  - 发送器置为**隐性**；
  - 接收器若接收到正确的报文，就会发送**显性电平**，否则依旧是隐性电平。
  - 由于是两个节点同时工作，ACK的电压会高一些。
- EOF：帧结束，由**7位隐性位**组成。
- ITM：帧间隔，3位隐性。

扩展帧的补充：

- SRR：无意义，1位隐性。
- Extended ID：扩展的18位帧ID。
- r1、r0：保留位，都是1位显性。

**CAN的应用开发者只使用其中的仲裁段、控制段和数据段。其他部分都由CAN底层固件自动封装。**

`ACK DEL`、`EOF`、`ITM` 组成11个连续隐性位。**当节点检测到11个连续隐性位时，判断为总线空闲**。

*Tip：对于11个连续隐性位的位填充问题，`CRC DEL`之前允许位填充，之后为**固定格式**，不允许位填充。*

### CAN远程帧 (遥控帧)

无数据，只有ID。用于向其他节点请求数据。

### CAN错误帧

- **位错误** (只能发送节点检测到)：回读位与发出时的位不一样。
- **位填充错误** (发送、接收节点皆可检测到)：总线上的信号违反位填充规则，如检测到大于5个连续的相同位。
- **ACK错误** (只能发送节点检测到)：发送节点发出一个1，回读时发现接收节点并没有把ACK置高为0。
- **格式错误** (发送、接收节点皆可检测到)：CRC之后的固定格式出错。
- **CRC错误** (只能接收节点检测到)：接收节点计算好CRC码后发现和发送节点的CRC码不一样。

以上是错误的分类，然而错误帧又有两种格式：**主动错误**和**被动错误**。

错误状态：

![47fc2fb39ad94ad0da9aea8eb8bd9e9](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/47fc2fb39ad94ad0da9aea8eb8bd9e9.jpg)

#### 错误帧的发送

![CAN错误帧的发送](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/CAN%E9%94%99%E8%AF%AF%E5%B8%A7%E7%9A%84%E5%8F%91%E9%80%81.png)

- 主动错误帧的错误标志为6位显性位，被动错误的错误标志为6位隐性位。
- 错误界定符都是8位隐性位。
- 错误标志叠加为0或6位显性。

为什么有错误标志叠加？发送节点在发送错误标志后，总线上会出现连续的相同位，这时先违反了**位填充规则**，因此接收节点也会发送错误帧，当接收节点处于**主动错误状态**时，传到总线上的错误标志为显性，会覆盖发送节点之前传上来的隐性界定符。错误标志叠加数量是0位还是6位取决于接收节点是否在主动错误状态。

![6f7a6ddbcce55ff9e83c122164c806e](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/6f7a6ddbcce55ff9e83c122164c806e.jpg)

如当发送方为主动错误状态时：

1. 出现错误，发送方发送了主动错误标志。
2. 接收方检测到CAN总线上有6个连续的相同位，判断为位填充错误。
   - 若接收方为主动错误状态，则发送主动错误标志，而标志为显性位，**覆盖**了发送方传到总线上的界定符隐性位，因此**形成错误标志叠加**。
   - 若接收方为被动错误状态，则发送被动错误标志，而标志为隐性位，**并不覆盖**发送方传到总线上的界定符隐性位，因此**没有形成错误标志叠加**。
3. 总线上8个连续隐性位为错误界定符，错误帧确定。

![1ac891bc3c4cbc015d8b4338a59e77b](https://image-hosting-1313474851.cos.ap-shanghai.myqcloud.com/Notes/1ac891bc3c4cbc015d8b4338a59e77b.jpg)

发送方为被动错误状态时同理。

### CAN超载帧

格式和主动错误帧一样。很少用了。

### 帧间空间

用于分隔帧与帧，但**超载帧和错误帧前面不会插入帧间空间**。

*Tip：对于被动错误节点，要在帧间空间过后发送错误帧，则需先有**8个隐性电平挂起**，而后再发送。原因是保证主动错误节点优先发送，避免被动错误节点因硬件故障干扰整个网络。*

---
